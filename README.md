# How to discover VMX features using GCP VM

1. Setup gcloud account 

2. Loign to console

3. Create a VM 
   ( for this project i created with following features 
    machine type: n2-standard-2
    OS: Ubntu
    )
4. Connect to machine using either by Browser based SSH or your own machine

5. Install gcloud CLI
   https://cloud.google.com/sdk/docs/install

6. Once intsalled initialize gcloud CLI
    `gcloud init`

7. We need to enable nested virtualization inorder to discover VMX features

8. To enable nested virtualization
   https://cloud.google.com/compute/docs/instances/nested-virtualization/enabling

9. In our case we already have a VM so we will export the property of the instance using
   `gcloud compute instances export instance-1  --destination=export.yaml   --zone=us-west4-b`
    
    Add following text to export.yaml file if its not already there 
    advancedMachineFeatures:
      enableNestedVirtualization: true

    Update the VM with following command
    `gcloud compute instances update-from-file instance-1  --source=export.yaml   --most-disruptive-allowed-action=RESTART --zone=us-west4-b`

10. To check if nested virtualization is enabled
    connect to VM and run the following command,it should any number other than 0
    `grep -cw vmx /proc/cpuinfo`

11. Create a dir and add the files Makefile and .c file to find the features

12. But first install dependencies
    `sudo bash`
    `apt install gcc make`
    `exit`
    `sudo apt-get install linux-headers-$(uname -r) `

13. If some issue with gcc then run update command and install again
    `update apt-get`
    `apt install gcc`
    `apt install make`

14. Run make to create output inside the directory
    `make`

15. Once you see the autogenerated files to see the output load the .ko file in kernel and read
     `sudo insmod cmpe283-1.ko`
     `dmesg`

16. To find about the MSR and controls that you want query 
    https://www.intel.com/content/dam/develop/public/us/en/documents/325384-sdm-vol-3abcd.pdf

